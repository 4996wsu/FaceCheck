{% extends 'main/base.html'%}
{% block title %}Manage Class{% endblock %}

{% block content %}
    <!-- TEMPORARY STYLE SHEET, DELETE LATER -->
    <style>
        /* GENERIC STYLES */
        h2 {
            margin-bottom: 1rem;
            text-align: center;
        }
        hr {
            width: 100%;
            margin-left: 0;
            margin-right: 0;
        }
        body {
            color: white;
            background-image: none;
            background-color: #131313;
        }

        /* TAB STYLES */
        .tab {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .tab button {
            flex: 1; /* Make the buttons evenly stretch */
            background-color: #f2f2f2;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 20px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        
        .tab button.active {
            background-color: #ddddddd4;
        }
        
        .tab button:hover {
            background-color: #ddddddef;
        }
        
        .tab-content {
            display: none;
            border-top: 2px solid transparent;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-content h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .tab-content p {
            font-size: 16px;
            line-height: 1.6;
        }

        @media screen and (max-width: 768px) {
            .tab button {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /*  TABLE FORMATTING STYLES  */
        @media (min-width: 1280px) {
            #indented_label {
                margin-left: 1em;
            }
        }

        @media (max-width: 1279px) {
            #indented_label::before {
                white-space: pre;
                display: block;
            }

            #semester_select,
            #class_id_select,
            #date_select,
            #searchbar,
            #filter_select {
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 0.5em;
            }

            .input-field {
                display: grid; 
                grid-template-columns: auto 1fr; 
                gap: 0.5em; 
                align-items: center; 
            }
        
            .input-field label {
                text-align: right; 
            }
        
            .input-field select {
                width: 100%; 
            }
        }

        #stats_table {
            margin-bottom: 3em;
        }
        th, tr {
            padding-right: 1rem;
        }
        .headcol_id, .headcol_name {
            position: sticky;
            white-space: nowrap;
            left: 0;
            background-color: #131313;
            z-index: 1;
        }
        .headcol_id {
            width: 5.5em;
        }
        .headcol_name {
            width: 10em;
        }
        .col, .col_name {
            position: relative;
            white-space: nowrap;
        }
        .col_name {
            width: 10em;
        }
    </style>

    <!-- STATISTICS PAGE CODE -->
    <h2>Manage Class</h2><hr>

    <!-- TABS -->
    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'tab_manage_class')" id="defaultOpen">Manage Students</button>
        <button class="tablinks" onclick="openTab(event, 'tab_add_students')">Add New Students</button>
    </div>
    

    <!-- INPUT FIELDS -->
    <div id = "input_fields">
        <label for="semester_select">Semester: </label>
        <select name="semester_select" id="semester_select" onchange = "change_semester()">
            <option value="default">N/A</option>
        </select>

        <label for="class_id_select" id="indented_label">Class: </label>
        <select name="class_id_select" id="class_id_select" disabled onchange = "change_class()">
            <option value="default">N/A</option>
        </select>


        <!-- TAB CONTENT -->
        <div id="tab_manage_class" class="tab-content active">
            <!-- SEARCH BAR -->
            <br><a>Search for a student: </a>
            <input id = "searchbar"
                onkeyup = "search_student()"
                type = "text" name = "search"
                maxlength = "20"
                placeholder = "Ex: hc9082">

            <label for="filter_select" id="indented_label">Search/sort by: </label>
            <select name="filter_select" id="filter_select" onchange = "change_filter()">
                <option value="accessid">Access ID</option>
                <option value="fname">First name</option>
                <option value="lname">Last name</option>
            </select>

            <hr>
            <a id = "errors">Select a semester and class to manage a class.</a>

            <!-- STATS TABLE BASE -->
            <div id = "stats_table" style="overflow-x:auto;">
                <table id = "stats">
                    <thead id="thead"></thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab_add_students" class="tab-content">
            <hr>
            <table id="add_student_table">
                <thead>
                    <tr>
                        <th>Access ID</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button onclick="addStudentRow()">+</button>
            <button onclick="submitTable()">Submit</button>
        </div>
    </div>
    

    <!-- JAVASCIPT CODE -->
    <script type="module">
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
        import { initializeApp, } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, collection, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";

        // Open different tabs
        function openTab(evt, tabName) {
            // Get all elements with class="tab-content" and hide them
            var tabContent = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabContent.length; i++) {
                tabContent[i].style.display = "none";
            }
        
            // Get all elements with class="tablinks" and remove the class "active"
            var tabLinks = document.getElementsByClassName("tablinks");
            for (var i = 0; i < tabLinks.length; i++) {
                tabLinks[i].className = tabLinks[i].className.replace(" active", "");
            }
        
            // Show the current tab content, and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        window.openTab = openTab;
        
        //  Open image preview
        function openImagePreview(imageUrl, studentName) {
            // Create overlay/modal element
            var overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999';
        
            // Create container for image and caption
            var container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.textAlign = 'center';
        
            // Create image element
            var image = document.createElement('img');
            image.src = imageUrl;
            image.style.maxWidth = '80%';
            image.style.maxHeight = '80%';
            image.style.display = 'block';
            image.style.margin = '0 auto';
        
            // Create caption element
            var caption = document.createElement('p');
            caption.textContent = "Photo for " + studentName;
            caption.style.color = '#fff';
            caption.style.fontFamily = 'Arial, sans-serif';
            caption.style.fontSize = '16px';
        
            // Append image and caption to container
            container.appendChild(image);
            container.appendChild(caption);
        
            // Append container to overlay
            overlay.appendChild(container);
        
            // Append overlay to body
            document.body.appendChild(overlay);
        
            // Close overlay when clicked
            overlay.onclick = function() {
                document.body.removeChild(overlay);
            };
        }
        window.openImagePreview = openImagePreview;

        // Show the default tab on page load
        document.getElementById("defaultOpen").click();

        function removeOptions(selectElement) {
            var i, len = selectElement.options.length - 1;
            for(i = len; i >= 0; i--) {
               selectElement.remove(i);
            }
         }

        const firebaseConfig = {
          apiKey: "AIzaSyAthInO0LFnRTXY9L2b7XUsLWO_UBXWg0c",
          authDomain: "facecheck-93450.firebaseapp.com",
          projectId: "facecheck-93450",
          storageBucket: "facecheck-93450.appspot.com",
          messagingSenderId: "691465641368",
          appId: "1:691465641368:web:31f2d89844617d5a0b5fed",
          measurementId: "G-FH3W7GY9NH"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage();
        const colRef = collection(db, "infoCollection");

        const studentSnapshot = await getDoc(doc(db, "infoCollection", "student_doc"));
        const classSnapshot = await getDoc(doc(db, "infoCollection", "class_doc"));
        const userSnapshot = await getDoc(doc(db, "infoCollection", "user_doc"));
        if (studentSnapshot.exists() && classSnapshot.exists() && userSnapshot.exists()){
            let studentData = studentSnapshot.data();
            let classData = classSnapshot.data();
            let userData = userSnapshot.data();
            let semester_select = document.getElementById("semester_select");
            let class_select = document.getElementById("class_id_select");
            let table = document.getElementById('stats');
            let filter = document.getElementById('filter_select').value;
            let error_msg = document.getElementById('errors');

            //  Save identifier keys and write initial table based on inputs
            var username = "{{ user.username }}";
            console.log("Logged in as:", username);
            let semester = 'N/A';
            let class_id = 'N/A';
            var students;   //  This is initialized with a value after a class is chosen
            let classes = Object.keys(classData.classes);
            let users = Object.keys(userData.users);
            write_semester_menu();

            //  Write contents of the semester menu
            function write_semester_menu() {
                if (classes.length > 0) {
                    // Create default value
                    removeOptions(semester_select);
                    var default_option = document.createElement('option');
                    default_option.value = 0;
                    default_option.innerHTML = "-- Click to select semester --"
                    default_option.disabled = true;
                    default_option.selected = true;
                    default_option.style.display = 'none';
                    semester_select.appendChild(default_option);

                    // Store semesters in array to check for duplicates
                    var semester_arr = [];

                    for (let class_id of classes) {
                        let class_arr = class_id.split('_');
                        var semester;
                        // Use a temporary naming scheme YYYY_Semester # to ensure that
                        // the list is sorted in correct semester order.
                        if (class_arr[3] === "W")
                            semester = class_arr[4] + "_1";
                        else if (class_arr[3] === "S")
                            semester = class_arr[4] + "_2";
                        else if (class_arr[3] === "F")
                            semester = class_arr[4] + "_3";

                        // Add to semester array if not already present
                        if (!semester_arr.includes(semester))
                            semester_arr.push(semester);
                    }
                    semester_arr.sort();

                    // Add semesters to drop down meny
                    for (var i = 0; i < semester_arr.length; i++) {
                        let arr = semester_arr[i].split('_');
                        var semester;

                        // Change class names to recorrect semester names
                        if (arr[1] === "1")
                            semester = "Winter " + arr[0];
                        else if (arr[1] === "2")
                            semester = "Spring/Summer " + arr[0];
                        else if (arr[1] === "3")
                            semester = "Fall " + arr[0];

                        var option = document.createElement('option');
                        option.value = semester;
                        option.innerHTML = semester;
                        semester_select.appendChild(option);
                    }
                }
                else {
                    console.log("Error: There are no semesters to show.");
                }
            }

            //  Handle semester select menu
            function change_semester() {
                let input = semester_select.value;
                if (input != "N/A") {
                    semester = input;
                    console.log(semester);
                    class_id = 'N/A';
                    write_class_menu();
                    class_select.removeAttribute("disabled");

                    search_student();
                }
                else {
                    console.log("Cannot change semester: No semesters exist")
                }
            }
            window.change_semester = change_semester;

            //  Write contents of class ID menu :: *****ADD PROFESSOR CHECK HERE*****
            function write_class_menu() {
                // Create default value
                removeOptions(class_select);
                let class_list = Object.keys(classData.classes);
                class_list.sort();

                var default_option = document.createElement('option');
                default_option.value = 0;
                default_option.innerHTML = "-- Click to select class --"
                default_option.disabled = true;
                default_option.selected = true;
                default_option.style.display = 'none';
                class_select.appendChild(default_option);

                for (var i = 0; i < class_list.length; i++) {
                    let class_arr = class_list[i].split('_');
                    var s = '';

                    //  Parse semester from class ID
                    if (class_arr[3] === "W")
                            s = "Winter " + class_arr[4];
                        else if (class_arr[3] === "S")
                            s = "Spring/Summer " + class_arr[4];
                        else if (class_arr[3] === "F")
                            s = "Fall " + class_arr[4];

                    //  Check if current class is part of the selected semester
                    if (semester === s) {
                        let info = Object.keys(classData.classes[class_list[i]]);
                        let arr = class_list[i].split("_");
                        let id = arr[0] + " " + arr[1] + " " + arr[2];

                        var option = document.createElement('option');
                        option.value = class_list[i];
                        option.innerHTML = id + " | " + classData.classes[class_list[i]]['class_name'];
                        class_select.appendChild(option);
                    }
                }
            }

            //  Handle class select menu
            function change_class() {
                let input = class_select.value;
                if (input != "N/A") {
                    if (studentData.students[input] !== undefined) {
                        class_id = input;
                        console.log(class_id);
                        students = Object.keys(studentData.students[class_id]);
                        console.log("Number of students: " + students.length);
                        search_student();
                    }
                    else {
                        console.log("Error: Class '" + input + "' does not exist in the attendance database.");
                        error_msg.innerHTML = "No data exists for this class.";
                    }
                }
                else {
                    console.log("Cannot change class ID: No class IDs exist");
                }
            }
            window.change_class = change_class;

            //  Handle search filter menu
            function change_filter() {
                filter = document.getElementById('filter_select').value;
                console.log("Selected filter: " + filter);
                let searchbar = document.getElementById('searchbar');
                if (filter === 'accessid')
                    searchbar.placeholder = "Ex: hc9082";
                else if (filter === 'fname')
                    searchbar.placeholder = "Enter first name";
                else if (filter === 'lname')
                    searchbar.placeholder = "Enter last name";
                search_student();
            }
            window.change_filter = change_filter;

            //  Handle search bar
            function search_student() {
                let input = document.getElementById('searchbar').value;

                if (input === "" && (class_id != 'N/A')) {
                    write_manage_table(students);
                }
                else if (class_id != 'N/A') {
                    input = input.toLowerCase();
                    let found_students = [];
                
                    //  Check for substring based on filter
                    if (filter === 'accessid') {
                        for (let i = 0; i < students.length; i++) {
                            if (students[i].toLowerCase().includes(input)) {
                                found_students.push(students[i]);
                            }
                        }
                    }
                    else if (filter === 'fname' || filter === 'lname') {
                        for (let i = 0; i < students.length; i++) {
                            let currentStudent = students[i];
                            if (userData['users'][currentStudent][filter].toLowerCase().includes(input)) {
                                found_students.push(students[i]);
                            }
                        }
                    }

                    if (found_students.length > 0) {
                        write_manage_table(found_students);
                    }
                    else {
                        empty_table();
                        error_msg.innerHTML = "No users found.";
                    }
                }
                else {
                    error_msg.innerHTML = "Select a semester and class to manage a class.";
                    empty_table();
                }
            }
            window.search_student = search_student;

            //  Empty stats table
            function empty_table() {
                while (table.firstChild)
                    table.removeChild(table.firstChild);
            }

            //  Sort students based on filter and return access ID order. Used for write_manage_table()
            function sort_by_filter(accessIDs) {
                let studentInfoArr = [];

                for (let i = 0; i < accessIDs.length; i++) {
                    const id = accessIDs[i];
                    const fname = userData.users[id]['fname'];
                    const lname = userData.users[id]['lname'];
                
                    const s = { id, fname, lname };
                    studentInfoArr.push(s);
                }

                if (filter === 'accessid') 
                    studentInfoArr.sort((a, b) => a.id.localeCompare(b.id));
                else if (filter === 'fname') 
                    studentInfoArr.sort((a, b) => a.fname.localeCompare(b.fname));
                else if (filter === 'lname') 
                    studentInfoArr.sort((a, b) => a.lname.localeCompare(b.lname));

                return studentInfoArr.map(user => user.id);
            }

            //  Create table
            async function write_manage_table(accessIDs) {
                error_msg.innerHTML = "";
            
                // Create an array to store promises for fetching photo URLs
                const photoPromises = [];

                let students = sort_by_filter(accessIDs);
            
                // Loop through students
                for (let currentStudent of students) {
                    let data = userData.users[currentStudent];
                    if (data) {
                        // Get student photo URL
                        const photoPromise = new Promise(async (resolve, reject) => {
                            try {
                                const storageRef = ref(storage, currentStudent + "_photo");
                                const photoUrl = await getDownloadURL(storageRef);
                                resolve({ photoUrl, student: currentStudent });
                            } catch (error) {
                                console.error("Error getting photo URL:", error);
                                resolve({ photoUrl: null, student: currentStudent });
                            }
                        });
            
                        photoPromises.push(photoPromise);
                    }
                }
            
                // Wait for all photo fetching promises to resolve
                Promise.all(photoPromises)
                    .then(results => {
                        // Clear the table content before adding new entries
                        empty_table();
            
                        let header = '';
                        // ----- Table header -----
                        if (filter === 'accessid') {
                            header = `<tr>
                                                <th class = "headcol_id">Access ID</th>
                                                <th class = "col_name">Name</th>`;
                        } else if (filter === 'fname' || filter === 'lname') {
                            header = `<tr>
                                                <th class = "headcol_name">Name</th>
                                                <th class = "col">Access ID</th>`;
                        }
                        header += '<th class = "col">Student Photo</th><th class = "col">Status</th></tr>';
                        table.innerHTML += header;
            
                        // Loop through results and add them to table rows accordingly
                        for (let i = 0; i < results.length; i++) {
                            const { photoUrl, student } = results[i];
                            let data = userData.users[student];
                            if (data) {
                                let row = '';
                                if (filter === 'accessid') {
                                    row = `<tr>
                                                <td class = "headcol_id">${student}</td>
                                                <td class = "col_name">${userData.users[student]['fname'] + " " +
                                                    userData.users[student]['lname']}</td>`;
                                } 
                                else if (filter === 'fname') {
                                    row = `<tr>
                                                <td class = "headcol_name">${userData.users[student]['fname'] + " " +
                                                    userData.users[student]['lname']}</td>
                                                <td class = "col">${student}</td>`;
                                } 
                                else if (filter === 'lname') {
                                    row = `<tr>
                                                <td class = "headcol_name">${userData.users[student]['lname'] + ", " +
                                                    userData.users[student]['fname']}</td>
                                                <td class = "col">${student}</td>`;
                                }
            
                                row +=
                                    `   <td class="col"><button onclick="openImagePreview('${photoUrl}','${student}')">
                                        View Photo</button></td>
                                    </tr>`;
            
                                table.innerHTML += row;
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching photo URLs:", error);
                    });
            }

            //  Add row to new student table
            function addStudentRow() {
                var table = document.getElementById("add_student_table").getElementsByTagName('tbody')[0];
                var newRow = table.insertRow();
                var cell1 = newRow.insertCell(0);
                var cell2 = newRow.insertCell(1);
                var idInput = document.createElement("input");
                idInput.type = "text";
                cell1.appendChild(idInput);
                var deleteButton = document.createElement("button");
                deleteButton.innerHTML = "&#x1F5D1";
                deleteButton.onclick = function() {
                    // Find the parent row and delete it
                    var row = this.parentNode.parentNode;
                    row.parentNode.removeChild(row);
                };
                cell2.appendChild(deleteButton);
            }
            window.addStudentRow = addStudentRow;
            //  Submit new student request
            function submitTable() {
                var table = document.getElementById("add_student_table");
                var data = [];
                for (var i = 1; i < table.rows.length; i++) {
                    var accessid = table.rows[i].cells[0].getElementsByTagName("input")[0].value;
                    data.push({ "accessid": accessid });
                }
                // DO SOMETHING
                console.log(data);
            }
            window.submitTable = submitTable;
        }
    </script>
{% endblock %}