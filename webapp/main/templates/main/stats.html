{% extends 'main/base.html'%}
{% block title %}Statistics Page{% endblock %}

{% block content %}
    <!-- TEMPORARY STYLE SHEET, DELETE LATER -->
    <!-- STATISTICS PAGE CODE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/styles/stats.css">


    <!-- Main page content -->
    <div id="main-content">
        <h2 class="headline"><span class="span">Attendance Statistics</span></h2><hr>

        <!-- Main container -->
        <div class="manage_container">

            <!-- Input fields -->
            <div id = "input_fields">
                <!-- Option drop-down menus -->
                <div class="option_bar_container">
                    <div class="drop-container">
                        <select name="semester_select" id="semester_select" class="option_bar" onchange="change_semester()">
                            <option value="default">Semester</option>
                        </select>
                        <img class="drop-icon" src="https://img.icons8.com/ios-filled/50/FFFFFF/circled-chevron-down.png" alt="circled-chevron-down"/>
                    </div>

                    <div class="drop-container">
                        <select name="class_id_select" id="class_id_select" class="option_bar" disabled onchange="change_class()">
                            <option value="default">Class</option>
                        </select>
                        <img class="drop-icon" src="https://img.icons8.com/ios-filled/50/FFFFFF/circled-chevron-down.png" alt="circled-chevron-down"/>
                    </div>

                    <div class="drop-container">
                        <select name="date_select" id="date_select" class="option_bar" onchange="change_date()" disabled>
                            <option value="default">Date</option>
                        </select>
                        <img class="drop-icon" src="https://img.icons8.com/ios-filled/50/FFFFFF/circled-chevron-down.png" alt="circled-chevron-down"/>
                    </div>

                    <!-- Wrapper for the last two elements -->
                    <div class="centered-elements">
                        <div class="search-container">
                            <input id="searchbar" class="option_bar" onkeyup="search_student()" type="text" name="search" maxlength="20" placeholder="Ex: hc9082">
                            <img class="search-icon" src="https://img.icons8.com/ios-filled/50/FFFFFF/search--v1.png" alt="search--v1"/>
                        </div>
                        <div class="select-container">
                            <select name="filter_select" id="filter_select" class="option_bar" onchange="change_filter()">
                                <option value="accessid">Access ID</option>
                                <option value="fname">First name</option>
                                <option value="lname">Last name</option>
                            </select>
                            <img class="filter-icon" src="https://img.icons8.com/ios-filled/50/FFFFFF/filter--v1.png" alt="filter--v1"/>
                        </div>
                    </div>
                </div>

                <!-- User instructions -->
                <p class="add_instruction" id = "errors">
                    Select a semester, class, and date to show attendance data.
                </p>

                <!-- Statistics table -->
                <div id = "stats_table" style="overflow-x:auto;">
                    <table id = "stats">
                        <thead id="thead"></thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>

                <div id = "update_buttons">
                    <button id = "confirm_changes" onClick="confirm_changes()">Confirm chages</button>
                    <button id = "revert_changes" onClick = "revert_changes()">Revert chages</button>
                </div>

                <!-- Face count graph -->
                <div id="face_count_graph"></div>
            </div>
        </div>
    </div>

    <!-- Seperate container for if user is denied access to the page -->
    <div id="access-denied">
        <p>Your account is not authorized to access this page.</p>
        <p>Return <a href="{% url 'home' %}" id="link_home">Home</a></p>
    </div>



    

    <!-- JAVASCIPT CODE -->
    <script src="https://cdn.anychart.com/releases/8.12.0/js/anychart-base.min.js" type="text/javascript"></script>
    <script type="module">
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
        import { initializeApp, } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, collection, query, where, getDocs, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";

        //  Remove all options from a select menu
        function removeOptions(selectElement) {
            var i, len = selectElement.options.length - 1;
            for(i = len; i >= 0; i--) {
               selectElement.remove(i);
            }
        }

        //  Open image preview
        function openImagePreview(imageUrl, date, time) {
            // Format date
            let dateArr = date.split("_");
            date = dateArr[0] + "/" + dateArr[1] + "/" + dateArr[2];

            // Format time
            let timeArr = time.split("_");
            if (parseInt(timeArr[0]) > 12) {
                timeArr[0] = (parseInt(timeArr[0]) - 12) + "";
                timeArr[2] = "PM"
            }
            else if (parseInt(timeArr[0]) === 12) {
                timeArr[0] = parseInt(timeArr[0]) + "";
                timeArr[2] = "PM"
            }
            else {
                timeArr[2] = "AM"
            }
            time = timeArr[0] + ":" + timeArr[1] + " " + timeArr[2];

            // Create overlay/modal element
            var overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999';
        
            // Create container for image and caption
            var container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.textAlign = 'center';
        
            // Create image element
            var image = document.createElement('img');
            image.src = imageUrl;
            image.style.maxWidth = '80%';
            image.style.maxHeight = '80%';
            image.style.display = 'block';
            image.style.margin = '0 auto';
        
            // Create caption element
            var caption = document.createElement('p');
            caption.textContent = "Class photo taken at " + time + " on " + date;
            caption.style.color = '#fff';
            caption.style.fontFamily = 'Arial, sans-serif';
            caption.style.fontSize = '16px';
        
            // Append image and caption to container
            container.appendChild(image);
            container.appendChild(caption);
        
            // Append container to overlay
            overlay.appendChild(container);
        
            // Append overlay to body
            document.body.appendChild(overlay);
        
            // Close overlay when clicked
            overlay.onclick = function() {
                document.body.removeChild(overlay);
            };
        }
        window.openImagePreview = openImagePreview;


        /* --------------------------------------------------  DATABASE CODE  --------------------------------------------------*/
        const firebaseConfig = {
          apiKey: "AIzaSyAthInO0LFnRTXY9L2b7XUsLWO_UBXWg0c",
          authDomain: "facecheck-93450.firebaseapp.com",
          projectId: "facecheck-93450",
          storageBucket: "facecheck-93450.appspot.com",
          messagingSenderId: "691465641368",
          appId: "1:691465641368:web:31f2d89844617d5a0b5fed",
          measurementId: "G-FH3W7GY9NH"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage();
        const colRef = collection(db, "infoCollection")

        const studentSnapshot = await getDoc(doc(db, "infoCollection", "student_doc"));
        const classSnapshot = await getDoc(doc(db, "infoCollection", "class_doc"));
        const userSnapshot = await getDoc(doc(db, "infoCollection", "user_doc"));
        if (studentSnapshot.exists() && classSnapshot.exists() && userSnapshot.exists()){
            let studentData = studentSnapshot.data();
            let classData = classSnapshot.data();
            let userData = userSnapshot.data();
            let date_select = document.getElementById("date_select");
            let semester_select = document.getElementById("semester_select");
            let class_select = document.getElementById("class_id_select");
            let table = document.getElementById('stats');
            let filter = document.getElementById('filter_select').value;
            let error_msg = document.getElementById('errors');

            //  Save identifier keys and write initial table based on inputs
            var username = "{{ user.username }}";
            console.log("Logged in as:", username);
            var date = 'N/A';
            var semester = 'N/A';
            var class_id = 'N/A';
            var students;   //  This is initialized with a value after a class is chosen
            var classes = get_class_list();
            var users = Object.keys(userData.users);
            write_semester_menu();

            //  Initialize a temporary data variable in case the user makes changes to overall attendance
            var tempStudentData = JSON.parse(JSON.stringify(studentData));

            //  Does user have access to this page?
            if (username != "") {
                if (userData.users[username]['role'] === "professor") {
                    document.getElementById("main-content").style.display = "block";
                    document.getElementById("access-denied").style.display = "none";
                }
                else {
                    document.getElementById("main-content").style.display = "none";
                    document.getElementById("access-denied").style.display = "block";
                }
            }
            else {
                document.getElementById("main-content").style.display = "none";
                document.getElementById("access-denied").style.display = "block";
            }

            //  Get class list based on which professor is logged in
            function get_class_list() {
                var classes = Object.keys(classData.classes);
                let final_class_list = [];

                for (let class_id of classes) {
                    if (classData.classes[class_id]['professor'] === username) {
                        final_class_list.push(class_id);
                    }
                }

                return final_class_list;
            }

            //  Write contents of the semester menu
            function write_semester_menu() {
                if (classes.length > 0) {
                    // Create default value
                    removeOptions(semester_select);
                    var default_option = document.createElement('option');
                    default_option.value = 0;
                    default_option.innerHTML = "Semester"
                    default_option.disabled = true;
                    default_option.selected = true;
                    default_option.style.display = 'none';
                    semester_select.appendChild(default_option);

                    // Store semesters in array to check for duplicates
                    var semester_arr = [];

                    for (let class_id of classes) {
                        let class_arr = class_id.split('_');
                        var semester;
                        // Use a temporary naming scheme YYYY_Semester # to ensure that
                        // the list is sorted in correct semester order.
                        if (class_arr[3] === "W")
                            semester = class_arr[4] + "_1";
                        else if (class_arr[3] === "S")
                            semester = class_arr[4] + "_2";
                        else if (class_arr[3] === "F")
                            semester = class_arr[4] + "_3";

                        // Add to semester array if not already present
                        if (!semester_arr.includes(semester))
                            semester_arr.push(semester);
                    }
                    semester_arr.sort();

                    // Add semesters to drop down meny
                    for (var i = 0; i < semester_arr.length; i++) {
                        let arr = semester_arr[i].split('_');
                        var semester;

                        // Change class names to recorrect semester names
                        if (arr[1] === "1")
                            semester = "Winter " + arr[0];
                        else if (arr[1] === "2")
                            semester = "Spring/Summer " + arr[0];
                        else if (arr[1] === "3")
                            semester = "Fall " + arr[0];

                        var option = document.createElement('option');
                        option.value = semester;
                        option.innerHTML = semester;
                        semester_select.appendChild(option);
                    }
                }
                else {
                    console.log("Error: There are no semesters to show.");
                }
            }

            //  Handle semester select menu
            function change_semester() {
                let input = semester_select.value;
                if (input != "N/A") {
                    semester = input;
                    console.log(semester);
                    class_id = 'N/A';
                    write_class_menu();
                    class_select.removeAttribute("disabled");
                    date_select.setAttribute("disabled", "disabled");

                    // Create default value for date select
                    removeOptions(date_select);
                    var default_option = document.createElement('option');
                    default_option.value = 0;
                    default_option.innerHTML = "N/A"
                    default_option.disabled = true;
                    default_option.selected = true;
                    default_option.style.display = 'none';
                    date_select.appendChild(default_option);
                    date = "N/A";

                    //  Update temporary studentData and hide buttons, then re-search for students.
                    studentData = JSON.parse(JSON.stringify(tempStudentData));
                    tempStudentData = JSON.parse(JSON.stringify(studentData));
                    show_buttons();
                    search_student();
                }
                else {
                    console.log("Cannot change semester: No semesters exist")
                }
            }
            window.change_semester = change_semester;

            //  Write contents of class ID menu
            function write_class_menu() {
                // Create default value
                removeOptions(class_select);
                let class_list = classes;
                class_list.sort();

                var default_option = document.createElement('option');
                default_option.value = 0;
                default_option.innerHTML = "Class"
                default_option.disabled = true;
                default_option.selected = true;
                default_option.style.display = 'none';
                class_select.appendChild(default_option);

                for (var i = 0; i < class_list.length; i++) {
                    let class_arr = class_list[i].split('_');
                    var s = '';

                    //  Parse semester from class ID
                    if (class_arr[3] === "W")
                            s = "Winter " + class_arr[4];
                        else if (class_arr[3] === "S")
                            s = "Spring/Summer " + class_arr[4];
                        else if (class_arr[3] === "F")
                            s = "Fall " + class_arr[4];

                    //  Check if current class is part of the selected semester
                    if (semester === s) {
                        let info = Object.keys(classData.classes[class_list[i]]);
                        let arr = class_list[i].split("_");
                        let id = arr[0] + " " + arr[1] + " " + arr[2];

                        var option = document.createElement('option');
                        option.value = class_list[i];
                        option.innerHTML = id + " | " + classData.classes[class_list[i]]['class_name'];
                        class_select.appendChild(option);
                    }
                }
            }

            //  Handle class select menu
            function change_class() {
                let input = class_select.value;
                if (input != "N/A") {
                    if (studentData.students[input] !== undefined) {
                        class_id = input;
                        console.log(class_id);
                        students = Object.keys(studentData.students[class_id]);
                        console.log("Number of students: " + students.length);
                        date = 'N/A';
                        write_date_menu();
                        date_select.removeAttribute("disabled");
                        error_msg.innerHTML = "Select a semester, class, and date to show attendance data.";

                        //  Update temporary studentData and hide buttons.
                        studentData = JSON.parse(JSON.stringify(tempStudentData));
                        tempStudentData = JSON.parse(JSON.stringify(studentData));
                        show_buttons();
                    }
                    else {
                        console.log("Error: Class '" + input + "' does not exist in the attendance database.");
                        error_msg.innerHTML = "No data exists for this class.";
                    }
                }
                else {
                    console.log("Cannot change class ID: No class IDs exist");
                }
            }
            window.change_class = change_class;

            //  Write contents of date menu
            function write_date_menu() {
                if (students.length > 0) {
                    //  Remove class_photos since it does not represent an actual student
                    let student_list = (Object.keys(studentData.students[class_id])).filter(item => item !== 'class_photos');
                    //student_list.sort();

                    //  Pick student with the most timestamps and use that to populate the date list
                    var chosen_student = student_list[0];
                    for (let student of student_list) {
                        if (Object.keys(studentData.students[class_id][student]['attendance']).length > 
                            Object.keys(studentData.students[class_id][chosen_student]['attendance']).length) {
                                chosen_student = student;
                            }
                    }

                    let date_list = Object.keys(studentData.students[class_id][chosen_student]['attendance']);
                    date_list.sort();

                    // Create default value
                    removeOptions(date_select);
                    var default_option = document.createElement('option');
                    default_option.value = 0;
                    default_option.innerHTML = "Date"
                    default_option.disabled = true;
                    default_option.selected = true;
                    default_option.style.display = 'none';
                    date_select.appendChild(default_option);

                    //  00/00/0000 is an empty date in the database, added just to initialize
                    //  a new student. The loop starts from 1 to avoid including this date.
                    for (var i = 1; i < date_list.length; i++) {
                        var option = document.createElement('option');
                        option.value = date_list[i];
                        let dateArr = date_list[i].split("_");
                        option.innerHTML = dateArr[0] + "/" + dateArr[1] + "/" + dateArr[2];
                        date_select.appendChild(option);
                    }
                }
                else {
                    console.log("Error: There are no dates to show.");
                }
            }

            //  Handle date select menu
            function change_date() {
                let input = date_select.value;
                if (input != "N/A") {
                    date = input;

                    //  Update temporary studentData and hide buttons, then re-search for students.
                    studentData = JSON.parse(JSON.stringify(tempStudentData));
                    tempStudentData = JSON.parse(JSON.stringify(studentData));
                    show_buttons();
                    search_student();
                }
                else {
                    console.log("Cannot change date: No dates present")
                }
            }
            window.change_date = change_date;

            //  Handle search filter menu
            function change_filter() {
                filter = document.getElementById('filter_select').value;
                console.log("Selected filter: " + filter);
                let searchbar = document.getElementById('searchbar');
                if (filter === 'accessid')
                    searchbar.placeholder = "Ex: hc9082";
                else if (filter === 'fname')
                    searchbar.placeholder = "Enter first name";
                else if (filter === 'lname')
                    searchbar.placeholder = "Enter last name";

                search_student();
            }
            window.change_filter = change_filter;

            //  Handle search bar
            function search_student() {
                let input = document.getElementById('searchbar').value;

                if (input === "" && (date != 'N/A')) {
                    write_table(students);
                }
                else if (date != 'N/A') {
                    input = input.toLowerCase();
                    let found_students = [];
                
                    //  Check for substring based on filter
                    if (filter === 'accessid') {
                        for (let i = 0; i < students.length; i++) {
                            if (students[i].toLowerCase().includes(input)) {
                                found_students.push(students[i]);
                            }
                        }
                    }
                    else if (filter === 'fname' || filter === 'lname') {
                        for (let i = 0; i < students.length; i++) {
                            let currentStudent = students[i];
                            if (userData['users'][currentStudent][filter].toLowerCase().includes(input)) {
                                found_students.push(students[i]);
                            }
                        }
                    }

                    if (found_students.length > 0) {
                        write_table(found_students);
                    }
                    else {
                        empty_table();
                        error_msg.innerHTML = "No users found.";
                    }
                }
                else {
                    document.getElementById("face_count_graph").innerHTML = "";
                    error_msg.innerHTML = "Select a semester, class, and date to show attendance data.";
                    empty_table();
                }
            }
            window.search_student = search_student;

            //  Empty stats table
            function empty_table() {
                while (table.firstChild)
                    table.removeChild(table.firstChild);
            }

            //  Sort students based on filter and return access ID order. Used for write_table()
            function sort_by_filter(accessIDs) {
                let studentInfoArr = [];

                for (let i = 0; i < accessIDs.length; i++) {
                    const id = accessIDs[i];
                    const fname = userData.users[id]['fname'];
                    const lname = userData.users[id]['lname'];
                
                    const s = { id, fname, lname };
                    studentInfoArr.push(s);
                }

                if (filter === 'accessid') 
                    studentInfoArr.sort((a, b) => a.id.localeCompare(b.id));
                else if (filter === 'fname') 
                    studentInfoArr.sort((a, b) => a.fname.localeCompare(b.fname));
                else if (filter === 'lname') 
                    studentInfoArr.sort((a, b) => a.lname.localeCompare(b.lname));

                return studentInfoArr.map(user => user.id);
            }

            //  Create table
            async function write_table(accessIDs) {
                console.log("Writing stats table");
                error_msg.innerHTML = "";

                // Create an array to store promises for fetching photo URLs
                const photoPromises = [];

                //  Remove "class_photos" from the accessIDs list since it is not a real student, then sort students
                if (accessIDs.includes("class_photos")) {
                    const index = accessIDs.indexOf("class_photos");
                    accessIDs.splice(index, 1);
                }
                let students = sort_by_filter(accessIDs);
                
                if (studentData.students[class_id]['class_photos'][date] !== undefined) {
                    let photo_timestamps = Object.keys(studentData.students[class_id]['class_photos'][date]);

                    for (let time of photo_timestamps) {
                        let data = studentData.students[class_id]['class_photos'][date][time];
                        if (data) {
                            // Get class photo URL
                            const photoPromise = new Promise(async (resolve, reject) => {
                                try {
                                    const storageRef = ref(storage, class_id + "/" + date + "/" + time + "_photo");
                                    const photoUrl = await getDownloadURL(storageRef);
                                    resolve({ photoUrl, timestamp: time });
                                } catch (error) {
                                    console.error("Error getting photo URL:", error);
                                    resolve({ photoUrl: null, timestamp: time });
                                }
                            });
                
                            photoPromises.push(photoPromise);
                        }
                    }
                }
                // Wait for all photo fetching promises to resolve
                Promise.all(photoPromises)
                    .then(results => {
                        // Clear the table content before adding new entries
                        empty_table();

                        let header = '';
                        //  ----- Table header -----
                        if (filter === 'accessid') {
                            header  =  `<tr>
                                                <th class = "headcol_id">Access ID</th>
                                                <th class = "col_name">Name</th>`;
                        }
                        else if (filter === 'fname' || filter === 'lname') {
                            header  =  `<tr>
                                                <th class = "headcol_name">Name</th>
                                                <th class = "col">Access ID</th>`;
                        }

                        //  Find student with the most timestamps
                        var student_index = 0;
                        var highest_length = 0;
                        for (var i = 0; i < students.length; i++) {
                            if (studentData.students[class_id][students[i]]['attendance'][date] !== undefined) {
                                let s = Object.keys(studentData.students[class_id][students[i]]['attendance'][date]).length
                                if (s > highest_length) {
                                    highest_length = s;
                                    student_index = i;
                                }
                            }
                        }

                        //  List all timestamps
                        let timestamps = Object.keys(studentData.students[class_id][students[student_index]]['attendance'][date]);
                        timestamps.sort(); 

                        //  Rearrange items so that "Overall" is the first timestamp
                        let overall_item = timestamps.filter(item => item === 'Overall');
                        let other_items = timestamps.filter(item => item !== 'Overall');
                        timestamps = overall_item.concat(other_items);

                        header += '<th class = "col">Overall</th>';
                        for (let key of other_items) {
                            let timeArr = key.split("_");
                            if (parseInt(timeArr[0]) > 12) {
                                timeArr[0] = (parseInt(timeArr[0]) - 12) + "";
                                timeArr[2] = "PM"
                            }
                            else if (parseInt(timeArr[0]) === 12) {
                                timeArr[0] = parseInt(timeArr[0]) + "";
                                timeArr[2] = "PM"
                            }
                            else {
                                timeArr[2] = "AM"
                            }
                            let time = timeArr[0] + ":" + timeArr[1] + " " + timeArr[2];
                            
                            //  Add timestamps headers
                            header += '<th class = "col">' + time + '</th>';
                        }
                        table.innerHTML += header

                        //  ----- Table contents -----
                        let row = ""

                        //  Loop through students
                        for (let student in students) {
                            let currentStudent = students[student]

                            if (studentData.students[class_id][currentStudent]['attendance'] !== undefined) {
                                //  Change table contents based on filter
                                if (filter === 'accessid') {
                                    row  = `<tr>
                                                <td class = "headcol_id">${currentStudent}</td>
                                                <td class = "col_name">${userData.users[currentStudent]['fname'] + " " + 
                                                    userData.users[currentStudent]['lname']}</td>`;
                                }
                                else if (filter === 'fname') {
                                    row  = `<tr>
                                                <td class = "headcol_name">${userData.users[currentStudent]['fname'] + " " + 
                                                    userData.users[currentStudent]['lname']}</td>
                                                <td class = "col">${currentStudent}</td>`;
                                }
                                else if (filter === 'lname') {
                                    row  = `<tr>
                                                <td class = "headcol_name">${userData.users[currentStudent]['lname'] + ", " + 
                                                    userData.users[currentStudent]['fname']}</td>
                                                <td class = "col">${currentStudent}</td>`;
                                }

                                //  Check if current student has the selected date
                                if (studentData.students[class_id][currentStudent]['attendance'][date] !== undefined) {
                                    let attendance = studentData.students[class_id][currentStudent]['attendance'][date];

                                    let student_timestamps = Object.keys(attendance);
                                    student_timestamps.sort();
                                    for (let key of timestamps) {
                                        let value = ""
                                        // This if statement checks if a student does not have a timestamp for a given time,
                                        // in case there was an error processing attendance for a given time.
                                        if (student_timestamps.includes(key)) {
                                            if (attendance[key] === true)
                                                value = "\u00A0\u2714";
                                            else
                                                value = "\u274C";
                                        }
                                        else {
                                            console.log("Error: missing timestamp for " + currentStudent + ".");
                                        }
                                        
                                        // Add button if writing overall attendance
                                        if (key === "Overall") {
                                            row += `<td class = "col">
                                                        <button class = "overall_button" 
                                                        id = "overall_button_${currentStudent}_${date}_${key}" 
                                                        onClick = "change_overall_attendance('${currentStudent}', '${date}', '${key}')">` + 
                                                            value + 
                                                        `</button>
                                                    </td>`;
                                        }
                                        else {
                                            row += `<td class = "col">` + value + `</td>`;
                                        }
                                    }
                                    row += '</tr>'
                                    table.innerHTML += row
                                }
                                else {
                                    console.log("This date does not exist for " + currentStudent)
                                }

                            } else {
                                console.log("No records for " + currentStudent);
                            }
                        }


                        //  Write class photos section of the table
                        if (filter === 'accessid') {
                            row  = `<tr>
                                        <td class = "headcol_id"></td>
                                        <td class = "col_name"></td>`;
                        }
                        else if (filter === 'fname' || filter === 'lname') {
                            row  = `<tr>
                                        <td class = "headcol_name"></td>
                                        <td class = "col"></td>`;
                        }
                        row += '<td class = "col"></td>'

                        if (studentData.students[class_id]['class_photos'][date] !== undefined) {
                            let photo_timestamps = Object.keys(studentData.students[class_id]['class_photos'][date]);
                            photo_timestamps.sort();

                            for (let i = 0; i < results.length; i++) {
                                const { photoUrl, timestamp } = results[i];
                                // This if statement checks if there is no class photo for a given time,
                                // in case there was an error processing attendance for a given time.
                                //console.log(studentData.students[class_id]['class_photos'][date][photo_timestamps[i]])
                                if (studentData.students[class_id]['class_photos'][date][photo_timestamps[i]] != "NO PHOTO") {
                                    row += `<td>
                                                <button onclick="openImagePreview('${photoUrl}','${date}','${photo_timestamps[i]}')">
                                                    View</button></td>`
                                }
                                else {
                                    row += "<td>N/A</td>"
                                    console.log("Error: missing timestamp for class photo.");
                                }
                            }
                        }

                        //  Conclude table and add to page
                        row += '</tr>'
                        table.innerHTML += row

                        //  Draw graph
                        show_face_count();
                    })
                    .catch(error => {
                        console.error("Error fetching photo URLs:", error);
                    });
            }

            //  Check if all nested objects are equal between two objects
            function deep_equal(obj1, obj2) {
                // Check if both are objects
                if (typeof obj1 === 'object' && typeof obj2 === 'object') {
                    // Get the keys of each object
                    const keys1 = Object.keys(obj1);
                    const keys2 = Object.keys(obj2);
            
                    // Check if the number of keys is the same
                    if (keys1.length !== keys2.length) {
                        return false;
                    }
            
                    // Check if all keys in obj1 are present in obj2 and have the same values
                    for (let key of keys1) {
                        if (!keys2.includes(key) || !deep_equal(obj1[key], obj2[key])) {
                            return false;
                        }
                    }
            
                    // If all keys and values are the same, return true
                    return true;
                } else {
                    // If both are not objects, perform a simple comparison
                    return obj1 === obj2;
                }
            }

            //  Change overall attendance
            function change_overall_attendance(accessid, date, time) {
                let btn = document.getElementById(`overall_button_${accessid}_${date}_${time}`)
                var value;

                //  Toggle button text content and save value
                if (btn.textContent === "\u00A0\u2714") {
                    value = false;
                    btn.textContent = "\u274C";
                }
                else {
                    value = true;
                    btn.textContent = "\u00A0\u2714";
                }

                //  Make changes in local data
                if (class_id != "N/A") {
                    studentData.students[class_id][accessid]['attendance'][date][time] = value;
                }

                //  Show buttons if needed
                show_buttons();
            }
            window.change_overall_attendance = change_overall_attendance;

            //  Check if student data has been modified on webapp
            function show_buttons() {
                let div = document.getElementById("update_buttons");
                if (!deep_equal(studentData, tempStudentData)) {
                    div.style.display = "flex";
                    console.log("Showing buttons");
                }
                else {
                    div.style.display = "none";
                    console.log("Hiding buttons");
                }
            }

            //  Reset any changes if not confirmed already
            async function revert_changes() {
                studentData = JSON.parse(JSON.stringify(tempStudentData));

                //  Hide buttons since there are no longer unsaved changes
                show_buttons();

                //  Refresh table
                search_student();
            }
            window.revert_changes = revert_changes;

            //  Confirm changes to student data
            async function confirm_changes() {
                tempStudentData = JSON.parse(JSON.stringify(studentData));

                //  Update in Firebase
                const doc_ref = doc(db, "infoCollection", "student_doc");
                await setDoc(doc_ref, studentData, { merge: true });

                //  Hide buttons since there are no longer unsaved changes
                show_buttons();
            }
            window.confirm_changes = confirm_changes;

            
            //  Show face count
            function show_face_count() {
                //  Get all students except "class_photos" since that does not represent a student
                let accessIDs = (Object.keys(studentData.students[class_id])).filter(item => item !== 'class_photos');
                accessIDs.sort();
                //  Get all timestamps for the chosen date
                let timestamps = (Object.keys(studentData.students[class_id][accessIDs[0]]['attendance'][date])).filter(item => item !== 'Overall');
                timestamps.sort();

                var data = [];
                for (let i = 0; i < timestamps.length; i++) {
                    //  Get face count
                    let face_count = 0;
                    for (let accessID of accessIDs) {
                        if (studentData.students[class_id][accessID]['attendance'][date] !== undefined)
                            if (studentData.students[class_id][accessID]['attendance'][date][timestamps[i]] !== undefined)
                                if (studentData.students[class_id][accessID]['attendance'][date][timestamps[i]] === true)
                                    face_count++;
                            else
                                console.log("Face count :: Cannot get timestamp for " + accessID);
                        else
                            console.log("Face count :: Cannot get date for " + accessID);
                    }

                    // Format time
                    let timeArr = timestamps[i].split("_");
                    if (parseInt(timeArr[0]) > 12) {
                        timeArr[0] = (parseInt(timeArr[0]) - 12) + "";
                        timeArr[2] = "PM"
                    }
                    else if (parseInt(timeArr[0]) === 12) {
                        timeArr[0] = parseInt(timeArr[0]) + "";
                        timeArr[2] = "PM"
                    }
                    else {
                        timeArr[2] = "AM"
                    }
                    let time = timeArr[0] + ":" + timeArr[1] + " " + timeArr[2];
                    console.log("Face count for " + time + ": " + face_count);
                    data.push([time, face_count]);
                }

                document.getElementById("face_count_graph").innerHTML = "";

                //  Create graph
                var chart = anychart.line();
                var data_set = anychart.data.set(data);
                var series_data = data_set.mapAs({x: 0, value: 1});
                var series = chart.line(series_data);

                //  Graph stylings using the AnyChart API
                chart.title("Attendance Per Time Interval");
                chart.container("face_count_graph");
                chart.yScale().minimum(0).ticks({interval: 1});
                chart.yGrid().enabled(true);

                chart.title().fontFamily("Oswald, sans-serif");
                chart.xAxis().labels().fontFamily("Oswald, sans-serif");
                chart.yAxis().labels().fontFamily("Oswald, sans-serif");
                chart.tooltip().fontFamily("Oswald, sans-serif").fontSize(14);

                chart.title().fontColor("#FFFFFF");                 // Title color
                chart.xAxis().labels().fontColor("#FFFFFF");        // X-axis labels color
                chart.yAxis().labels().fontColor("#FFFFFF");        // Y-axis labels color
                chart.yGrid().stroke({color: "#333333"});           // Y-axis tick marks color
                chart.background().fill("#131313");                 // Background fill
                series.stroke({color: "#4CAF50", thickness: 2});    // Line color

                //  Edit tooltip
                chart.tooltip().format(function() {
                    return 'No. of Students Present: ' + this.value;
                });

                //  Draw gaph
                chart.draw();
            }
        }
    </script>
{% endblock %}