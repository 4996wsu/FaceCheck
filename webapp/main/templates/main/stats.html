{% extends 'main/base.html'%}
{% block title %}Statistics Page{% endblock %}

{% block content %}
    <!-- TEMPORARY STYLE SHEET, DELETE LATER -->
    <style>
        h1 {
            margin-bottom: 1rem;
        }
        body {
            color: white;
            background-image: none;
            background-color: #131313;
        }
        .headcol {
            position: sticky;
            left: 0;
            width: 5.5em;
            background-color: #131313;
            z-index: 1;
        }
        .col {
            position: relative;
            white-space: nowrap;
        }
        th, tr {
            padding-right: 1rem;
        }
    </style>

    <!-- STATISTICS PAGE CODE -->
    <h1>Statistics</h1>

    <label for="semester_select">Semester: </label>
    <select name="semester_select" id="semester_select">
        <option value="default">N/A</option>
    </select>
    <a>&emsp;</a>

    <label for="class_id_select">Class ID: </label>
    <select name="class_id_select" id="class_id_select">
        <option value="default">N/A</option>
    </select>
    <a>&emsp;</a>

    <label for="date_select">Date: </label>
    <select name="date_select" id="date_select" onchange = "change_date()">
        <option value="default">N/A</option>
    </select>

    <!-- SEARCH BAR -->
    <br><br><a>Search for a student: </a>
    <input id = "searchbar"
        onkeyup = "search_student()"
        type = "text" name = "search"
        maxlength = "20"
        placeholder = "Ex: hc9082">
    <a>&emsp;</a>

    <label for="filter_select">Search by: </label>
    <select name="filter_select" id="filter_select" onchange = "change_filter()">
        <option value="accessid">Access ID</option>
        <option value="fname">First name</option>
        <option value="lname">Last name</option>
    </select>
    <hr>
    <a id = "errors">Select a semester, class, and date to show attendance data.</a>

    <!-- STATS TABLE BASE -->
    <div style="overflow-x:auto;">
        <table id = "stats">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
    
    <script type="module">
        import { initializeApp, } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, collection, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";

        function removeOptions(selectElement) {
            var i, len = selectElement.options.length - 1;
            for(i = len; i >= 0; i--) {
               selectElement.remove(i);
            }
         }

        const firebaseConfig = {
          apiKey: "AIzaSyAthInO0LFnRTXY9L2b7XUsLWO_UBXWg0c",
          authDomain: "facecheck-93450.firebaseapp.com",
          projectId: "facecheck-93450",
          storageBucket: "facecheck-93450.appspot.com",
          messagingSenderId: "691465641368",
          appId: "1:691465641368:web:31f2d89844617d5a0b5fed",
          measurementId: "G-FH3W7GY9NH"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const colRef = collection(db, "infoCollection")

        const studentSnapshot = await getDoc(doc(db, "infoCollection", "student_doc"));
        const classSnapshot = await getDoc(doc(db, "infoCollection", "class_doc"));
        if (studentSnapshot.exists() && classSnapshot.exists()){
            let studentData = studentSnapshot.data();
            let classData = classSnapshot.data();
            let date_select = document.getElementById("date_select")
            let semester_select = document.getElementById("semester_select")
            let class_select = document.getElementById("class_id_select")
            let table = document.getElementById('stats');
            let filter = document.getElementById('filter_select').value;
            let error_msg = document.getElementById('errors');

            //  Save identifier keys and write initial table based on inputs
            let date = 'None';
            let class_id = 'CSC_4996_001_W_2024';
            let students = Object.keys(studentData.students[class_id]);
            let classes = Object.keys(classData.classes);
            write_semester_menu();
            write_date_menu();

            //  Write contents of the semester menu
            function write_semester_menu() {
                if (classes.length > 0) {
                    // Create default value
                    removeOptions(document.getElementById('semester_select'));
                    var default_option = document.createElement('option');
                    default_option.value = 0;
                    default_option.innerHTML = "-- Click to select semester --"
                    default_option.disabled = true;
                    default_option.selected = true;
                    default_option.style.display = 'none';
                    semester_select.appendChild(default_option);

                    // Store semesters in array to check for duplicates
                    var semester_arr = [];

                    for (let class_id of classes) {
                        let class_arr = class_id.split('_');
                        var semester;
                        // Use a temporary naming scheme YYYY_Semester # to ensure that
                        // the list is sorted in correct semester order.
                        if (class_arr[3] === "W")
                            semester = class_arr[4] + "_1";
                        else if (class_arr[3] === "S")
                            semester = class_arr[4] + "_2";
                        else if (class_arr[3] === "F")
                            semester = class_arr[4] + "_3";

                        // Add to semester array if not already present
                        if (!semester_arr.includes(semester))
                            semester_arr.push(semester);
                    }
                    semester_arr.sort();

                    // Add semesters to drop down meny
                    for (var i = 0; i < semester_arr.length; i++) {
                        let arr = semester_arr[i].split('_');
                        var semester;

                        // Change class names to recorrect semester names
                        if (arr[1] === "1")
                            semester = "Winter " + arr[0];
                        else if (arr[1] === "2")
                            semester = "Spring/Summer " + arr[0];
                        else if (arr[1] === "3")
                            semester = "Fall " + arr[0];

                        var option = document.createElement('option');
                        option.value = semester;
                        option.innerHTML = semester;
                        semester_select.appendChild(option);
                    }
                }
                else {
                    console.log("Error: There are no semesters to show.");
                }
            }

            //  Write contents of class ID menu :: *****ADD PROFESSOR CHECK HERE*****
            function write_class_menu() {
                // Create default value
                removeOptions(document.getElementById('class_id_select'));
                let class_list = Object.keys(classData.classes);
                class_list.sort();

                var default_option = document.createElement('option');
                default_option.value = 0;
                default_option.innerHTML = "-- Click to select class --"
                default_option.disabled = true;
                default_option.selected = true;
                default_option.style.display = 'none';
                date_select.appendChild(default_option);

                for (var i = 0; i < class_list.length; i++) {
                    var option = document.createElement('option');
                    option.value = class_list[i];
                    let dateArr = class_list[i].split("_");
                    option.innerHTML = dateArr[0] + "/" + dateArr[1] + "/" + dateArr[2];
                    date_select.appendChild(option);
                }
            }

            //  Write contents of date menu
            function write_date_menu() {
                if (students.length > 0) {
                    let date_list = Object.keys(studentData.students[class_id][students[0]]['attendance']);
                    date_list.sort();

                    // Create default value
                    removeOptions(document.getElementById('date_select'));
                    var default_option = document.createElement('option');
                    default_option.value = 0;
                    default_option.innerHTML = "-- Click to select date --"
                    default_option.disabled = true;
                    default_option.selected = true;
                    default_option.style.display = 'none';
                    date_select.appendChild(default_option);

                    //  00/00/0000 is an empty date in the database, added just to initialize
                    //  a new student. The loop starts from 1 to avoid including this date.
                    for (var i = 1; i < date_list.length; i++) {
                        var option = document.createElement('option');
                        option.value = date_list[i];
                        let dateArr = date_list[i].split("_");
                        option.innerHTML = dateArr[0] + "/" + dateArr[1] + "/" + dateArr[2];
                        date_select.appendChild(option);
                    }
                }
                else {
                    console.log("Error: There are no dates to show.");
                }
            }

            //  Handle date change menu
            function change_date() {
                let input = document.getElementById('date_select').value;
                if (input != "N/A") {
                    date = input;
                    search_student();
                }
                else {
                    console.log("Cannot change date: No dates present")
                }
            }
            window.change_date = change_date;

            //  Handle search filter menu
            function change_filter() {
                filter = document.getElementById('filter_select').value;
                search_student();
            }

            //  Handle search bar
            function search_student() {
                let input = document.getElementById('searchbar').value;
                students = Object.keys(studentData.students[class_id]);

                if (input === "" && (document.getElementById('date_select').value != 0)) {
                    write_table(students);
                }
                if (document.getElementById('date_select').value != 0) {
                    input = input.toLowerCase();
                    let found_students = [];
                
                    for (let i = 0; i < students.length; i++) {
                        if (students[i].toLowerCase().includes(input)) {
                            found_students.push(students[i]);
                        }
                    }
                    if (found_students.length > 0) {
                        write_table(found_students);
                    }
                    else {
                        empty_table();
                        error_msg.innerHTML = "No users found.";
                    }
                }
                else {
                    error_msg.innerHTML = "Select a semester, class, and date to show attendance data.";
                }
            }
            window.search_student = search_student;

            //  Empty stats table
            function empty_table() {
                while (table.firstChild)
                    table.removeChild(table.firstChild);
            }

            //  Create table
            function write_table(students) {
                error_msg.innerHTML = "";
                empty_table();
                students.sort();

                //  ----- Table header -----
                let header  =  `<tr>
                    <th class = "headcol">Access ID</th>`;

                //  List all timestamps
                let timestamps = Object.keys(studentData.students[class_id][students[0]]['attendance'][date]); 
                timestamps.sort();
                for (let key of timestamps) {
                    let timeArr = key.split("_");
                    if (parseInt(timeArr[0]) > 12) {
                        timeArr[0] = (parseInt(timeArr[0]) - 12) + "";
                        timeArr[2] = "PM"
                    }
                    else if (parseInt(timeArr[0]) === 12) {
                        timeArr[0] = parseInt(timeArr[0]) + "";
                        timeArr[2] = "PM"
                    }
                    else {
                        timeArr[2] = "AM"
                    }
                    let time = timeArr[0] + ":" + timeArr[1] + " " + timeArr[2];
                    
                    //  Add margin if first entry, otherwise use normal margins
                    header += '<th class = "col">' + time + '</th>';
                }
                table.innerHTML += header

                //  ----- Table contents -----
                let row = ""

                //  Loop through students
                for (let student in students) {
                    let currentStudent = students[student]

                    if (studentData.students[class_id][currentStudent]['attendance'] !== undefined) {
                        //console.log("Checking: " + currentStudent)

                        row  = `<tr>
                                    <td class = "headcol">${currentStudent}</td>`;

                        let attendance = studentData.students[class_id][currentStudent]['attendance'][date];

                        let timestamps = Object.keys(attendance);
                        for (let key of timestamps) {
                            let value = ""
                            if (attendance[key] === true)
                                value = "\u2714";
                            else
                                value = "\u274C";
                            
                            row += '<td class = "col">' + value + '</td>';
                        }
                        row += '</tr>'
                        table.innerHTML += row

                    } else {
                        console.log("No records for " + currentStudent);
                    }
                }
            }

        }
    </script>
{% endblock %}